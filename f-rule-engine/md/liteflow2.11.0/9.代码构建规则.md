# 9.ä»£ç æ„å»ºè§„åˆ™

# ğŸ„è¯´æ˜

ä¹‹å‰çš„ç« èŠ‚è®²è¿°çš„æ˜¯é€šè¿‡è§„åˆ™æ–‡ä»¶å»æ„é€ æµç¨‹ã€‚

LiteFlowä¹Ÿæ”¯æŒç”¨ä»£ç å»æ„é€ æµç¨‹ï¼Œä½ å¯ä»¥ä¸ç”¨å†™xml/json/yamlçš„è§„åˆ™æ–‡ä»¶ï¼ŒruleSourceä¸ç”¨å»å®šä¹‰ã€‚å®Œå…¨ç”¨ä»£ç å»æ„å»ºã€‚

äº‹å®ä¸Šï¼ŒLiteFlowçš„è§„åˆ™æ— è®ºæ˜¯ä»€ä¹ˆæ ¼å¼çš„ï¼Œæœ€ç»ˆåº•å±‚ä¹Ÿæ˜¯ç”±æ„é€ é“¾å»æ„é€ çš„ã€‚

æ„ä¹‰

æä¾›åŠ¨æ€ä»£ç æ„é€ çš„APIæ„ä¹‰åœ¨äºä»¥ä¸‹ä¸¤ç‚¹ï¼š

- æœ‰äº›è§„åˆ™å¹¶ä¸æ˜¯åœ¨é¡¹ç›®å¯åŠ¨æ—¶å°±ç¡®å®šçš„ã€‚ä½ å¯ä»¥é€šè¿‡æ„é€ æ¨¡å¼ï¼Œä»¥ä»£ç å½¢å¼çš„æ–¹å¼å»åŠ¨æ€æ„é€ ä¸€æ¡é“¾è·¯ï¼Œä¹Ÿå¯ä»¥å»æ›¿æ¢ä¸€æ¡é“¾è·¯ã€‚
- å¦‚æœä½ æƒ³æŠŠè§„åˆ™çš„ç»†èŠ‚ç‚¹å­˜æ•°æ®åº“(è€Œä¸æ˜¯å­˜æ•´æ®µè§„åˆ™æ–‡ä»¶)ï¼Œé‚£ä¹ˆåŠ¨æ€ä»£ç æ„é€ æ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ã€‚åªä¸è¿‡ï¼Œä½ éœ€è¦åœ¨åº”ç”¨å¯åŠ¨æ—¶è‡ªå·±å†™é€»è¾‘å»è¯»åº“ï¼Œç„¶åç”¨åŠ¨æ€ä»£ç æ„é€ APIå»æ„é€ é“¾è·¯ã€‚

LiteFlowè®¾è®¡äº†éå¸¸ç®€å•çš„æ„é€ æ–¹æ³•é“¾å¼APIï¼Œè®©ä½ å¯ä»¥å¾ˆè½»æ¾çš„æ„é€ ä¸€æ¡é“¾è·¯ã€‚

å¹¶ä¸”ï¼Œè¿™ä¸€åˆ‡åŒè§„åˆ™æ–‡ä»¶ä¸€æ ·ï¼Œéƒ½æ˜¯æ”¯æŒå¹³æ»‘çƒ­åˆ·æ–°çš„ï¼Œä½ å®Œå…¨ä¸å¿…æ‹…å¿ƒåœ¨é«˜å¹¶å‘æ—¶æ›´æ¢æµç¨‹ä¼šé€ æˆé“¾è·¯é”™ä¹±çš„é—®é¢˜ã€‚å…³äºå¹³æ»‘çƒ­åˆ·æ–°ï¼Œå¯ä»¥å‚è€ƒ[å¹³æ»‘çƒ­åˆ·æ–°](https://liteflow.yomahub.com/pages/204d71/)ã€‚



# ğŸ¯å¦‚ä½•æ„é€ 

è¦è¯´æ˜çš„æ˜¯ï¼Œæ„é€ æ¨¡å¼å’Œè§„åˆ™é…ç½®æ¨¡å¼ï¼Œå…¶å®å¹¶ä¸æ˜¯åªèƒ½äºŒé€‰ä¸€ã€‚ä»–ä»¬æ—¢å¯ä»¥å•ç‹¬ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥ç»“åˆèµ·æ¥ä½¿ç”¨ï¼Œå¹¶ä¸å†²çªã€‚äº‹å®ä¸Šï¼Œå³ä¾¿æ˜¯è§„åˆ™é…ç½®æ¨¡å¼ï¼Œåº•å±‚ä¹Ÿä½¿ç”¨äº†æ„é€ æ¨¡å¼ã€‚æ‰€ä»¥ï¼Œæ‚¨éšæ„å°±æ˜¯ã€‚

## [#](https://liteflow.yomahub.com/pages/6bc8fe/#ä»€ä¹ˆæ—¶å€™æ„é€ )ä»€ä¹ˆæ—¶å€™æ„é€ 

å»ºè®®åœ¨é¡¹ç›®å¯åŠ¨æ—¶æ„é€ ï¼Œä»¥ä¸‹åªéœ€è¦æ„é€ ä¸€æ¬¡ã€‚åƒä¸‡ä¸è¦æ¯æ¬¡æ‰§è¡Œçš„æ—¶å€™éƒ½å»æ„é€ ï¼ï¼ï¼

## [#](https://liteflow.yomahub.com/pages/6bc8fe/#æ„é€ node)æ„é€ Node

æç¤º

ä½ å¯ä»¥åƒä»¥ä¸‹é‚£æ ·æ„é€ ä¸€ä¸ªæ™®é€šçš„Nodeï¼Œå½“ç„¶åœ¨spring/springbootç¯å¢ƒï¼Œå¤§å¤šæ•°æƒ…å†µä½ æ— éœ€å»æ„å»ºä¸€ä¸ªNodeï¼Œå› ä¸ºåªè¦ä½ çš„ç»„ä»¶ä¸Šæ ‡æœ‰`@Component`/`@LiteflowComponent`ï¼Œå¹¶ä¸”è¢«scanåˆ°çš„è¯ï¼Œç»„ä»¶ä¼šè‡ªåŠ¨æ³¨å†Œã€‚

æˆ‘è¿™é‡Œåªæ˜¯å‘Šè¯‰æ‚¨ï¼Œå¯ä»¥è¿™æ ·å»é€šè¿‡ä»£ç å»æ„é€ ï¼Œå¦‚æœä½ çš„ç»„ä»¶æ˜¯åŠ¨æ€ä»£ç†ç±»è€Œä¸æ˜¯ä¸€ä¸ªé™æ€å­˜åœ¨çš„javaç±»ï¼Œæˆ–æ˜¯è„šæœ¬èŠ‚ç‚¹ï¼Œè¿™æ ·çš„æ„å»ºå°±æ˜¾å¾—å¾ˆæœ‰æ„ä¹‰äº†ã€‚

å…³äºè„šæœ¬èŠ‚ç‚¹çš„æ¦‚å¿µï¼Œå¯ä»¥æŸ¥çœ‹[å®šä¹‰è„šæœ¬ç»„ä»¶](https://liteflow.yomahub.com/pages/81d53c/)

```java
//æ„å»ºä¸€ä¸ªæ™®é€šç»„ä»¶
LiteFlowNodeBuilder.createCommonNode().setId("a")
                .setName("ç»„ä»¶A")
                .setClazz("com.yomahub.liteflow.test.builder.cmp.ACmp")
                .build();

//æ„å»ºä¸€ä¸ªæ™®é€šæ¡ä»¶ç»„ä»¶
LiteFlowNodeBuilder.createSwitchNode().setId("a")
                .setName("ç»„ä»¶A")
                .setClazz("com.yomahub.liteflow.test.builder.cmp.ACmp")
                .build();

//æ„å»ºä¸€ä¸ªè„šæœ¬ç»„ä»¶
LiteFlowNodeBuilder.createScriptNode().setId("a")
                .setName("ç»„ä»¶A")
                .setScript("ä½ çš„è„šæœ¬")
                .build();

//æ„å»ºä¸€ä¸ªè„šæœ¬æ¡ä»¶ç»„ä»¶
LiteFlowNodeBuilder.createScriptSwitchNode().setId("a")
                .setName("ç»„ä»¶A")
                .setScript("ä½ çš„è„šæœ¬")
                .build();

//æ„å»ºä¸€ä¸ªè„šæœ¬ç»„ä»¶ï¼Œä»fileè½½å…¥è„šæœ¬
LiteFlowNodeBuilder.createScriptNode().setId("a")
                .setName("ç»„ä»¶A")
                .setFile("xml-script-file/s1.groovy")
                .build();
```

æç¤º

è¿™é‡Œçš„èŠ‚ç‚¹ç±»ï¼Œä¸éœ€è¦ä½ å»å£°æ˜`@LiteflowComponent`æˆ–è€…`@Component`ï¼Œå¦‚æœé¡¹ç›®æ˜¯springä½“ç³»çš„è¯ï¼ŒLiteFlowæ¡†æ¶ä¼šè‡ªåŠ¨çš„æŠŠèŠ‚ç‚¹ç±»æ³¨å…¥åˆ°springä¸Šä¸‹æ–‡ä¸­ã€‚

æ‰€ä»¥ä½ ä»æ—§å¯ä»¥åœ¨è¿™ä¸ªç±»é‡Œä½¿ç”¨@Autowiredå’Œ@Resourceç­‰ç­‰ä¹‹ç±»çš„springä»»ä½•æ³¨è§£ã€‚

## [#](https://liteflow.yomahub.com/pages/6bc8fe/#æ„å»ºä¸€ä¸ªchain)æ„å»ºä¸€ä¸ªChain

ä½ å¯ä»¥åƒä»¥ä¸‹é‚£æ ·æ„é€ ä¸€ä¸ªchainï¼Œç”±äºå’Œè§„åˆ™å®šä¹‰çš„æ²¡å†²çªã€‚ä½ ä¹Ÿå¯ä»¥å’Œè§„åˆ™æ–‡ä»¶ç»“åˆèµ·æ¥ç”¨ã€‚å½“buildçš„æ—¶å€™ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ·»åŠ ï¼Œå¦‚æœæœ‰åˆ™ä¿®æ”¹ã€‚

```java
LiteFlowChainELBuilder.createChain().setChainName("chain2").setEL(
  "THEN(a, b, WHEN(c, d))"
).build();
```

å€¼å¾—æä¸€ä¸‹çš„æ˜¯ï¼Œç”±äºç”¨æ„é€ æ¨¡å¼æ˜¯ä¸€ä¸ªé“¾è·¯ä¸€ä¸ªé“¾è·¯çš„æ·»åŠ ï¼Œå¦‚æœä½ ç”¨äº†å­æµç¨‹ï¼Œå¦‚æœchain1ä¾èµ–chain2ï¼Œé‚£ä¹ˆchain2è¦å…ˆæ„å»ºã€‚å¦åˆ™ä¼šæŠ¥é”™ã€‚

ä½†æ˜¯ç»è¿‡ä¸Šé¢å‡ ç« çš„å­¦ä¹ ï¼Œå…¶å®ä¸€ä¸ªELè¡¨è¾¾å¼å®Œå…¨å¯ä»¥è¡¨ç¤ºä¸€ä¸ªå¤æ‚çš„æµç¨‹ï¼Œå³ä¾¿ä¸èƒ½ä¹Ÿå¯ä»¥ç”¨å­å˜é‡æ¥ä¼˜åŒ–æµç¨‹ã€‚

## [#](https://liteflow.yomahub.com/pages/6bc8fe/#é”€æ¯ä¸€ä¸ªchain)é”€æ¯ä¸€ä¸ªChain

LiteFlowä¸­å…è®¸ä½ æ‰‹åŠ¨è¿è¡Œä»¥ä¸‹ä»£ç æ¥é”€æ¯ä¸€ä¸ªæµç¨‹ï¼š

```java
FlowBus.removeChain("ä½ çš„æµç¨‹ID")
```

# ğŸŒ°æ„é€ EL

## [#](https://liteflow.cc/pages/a3cb4b/#ä¾èµ–)ä¾èµ–

ä»2.11.1ç‰ˆæœ¬å¼€å§‹ï¼Œä½ å¯ä»¥åœ¨ä»£ç ä¸­åŠ¨æ€ç»„è£…ELè¡¨è¾¾å¼ï¼ŒåŒ…æ‹¬åˆ›å»ºã€ä¿®æ”¹ã€è¾“å‡ºELè¡¨è¾¾å¼ã€‚

å¦‚æœéœ€è¦åœ¨ä»£ç ä¸­åŠ¨æ€æ„å»ºELè¡¨è¾¾å¼ï¼Œéœ€è¦æ·»åŠ ä»¥ä¸‹é¢å¤–ä¾èµ–ï¼š

```xml
<dependency>
    <groupId>com.yomahub</groupId>
    <artifactId>liteflow-el-builder</artifactId>
    <version>2.11.1</version>
</dependency>
```

## [#](https://liteflow.cc/pages/a3cb4b/#æ„å»ºä¸€ä¸ªelè¡¨è¾¾å¼)æ„å»ºä¸€ä¸ªELè¡¨è¾¾å¼

ä½ å¯ä»¥é€šè¿‡å·¥å‚ç±»ELBusåˆ›å»ºä»»ä½•ä¸€ä¸ªELè¡¨è¾¾å¼ã€‚æ¯”å¦‚å¯¹äºè¿™æ ·ä¸€ä¸ªELè¡¨è¾¾å¼ï¼š

å›¾ç¤º

![img](https://liteflow.cc/img/flow_example/e3.svg)

å¯ä»¥è°ƒç”¨å¦‚ä¸‹æ–¹æ³•ç»„è£…è¯¥è¡¨è¾¾å¼ï¼š

```java
// ç»„è£…ELè¡¨è¾¾å¼
ThenELWrapper el = ELBus.then("a",
		ELBus.when("b").when(ELBus.then("c", "d")),
		"e");
```

å¯ä»¥è°ƒç”¨`toEL()`æ–¹æ³•è¾“å‡ºELè¡¨è¾¾å¼ï¼š

```java
THEN(node("a"),WHEN(node("b"),THEN(node("c"),node("d"))),node("e"))
```

com.yomahub.liteflow.builder.el.ELWrapperä»¿mybatis-plusçš„queryWarapperåˆ©ç”¨toELæ–¹æ³•å»æ„å»ºelè¡¨è¾¾å¼çš„å­—ç¬¦ä¸²

***éæ ¼å¼åŒ–è¾“å‡ºELè¡¨è¾¾å¼***

```java
public String toEL(){
        StringBuilder paramContext = new StringBuilder();
        String elContext = toEL(null, paramContext);
        return paramContext.append(elContext).toString();
    }
```

***æ˜¯å¦æ ¼å¼åŒ–è¾“å‡ºæ ‘å½¢ç»“æ„çš„è¡¨è¾¾å¼***

```
public String toEL(boolean format){
        StringBuilder paramContext = new StringBuilder();
        String elContext;
        if(!format){
            elContext = toEL(null, paramContext);
        } else {
            elContext = toEL(0, paramContext);
        }
        return paramContext.append(elContext).toString();
    }
```

com.yomahub.liteflow.builder.el.ELBusåˆ©ç”¨å¤šæ€æ„å»ºè¿ç»­å¤šå±‚el_data

**åˆ©ç”¨åŒåæ–¹æ³•çš„ä¸åŒå®ç°æ¥æŒç»­ä¸åœåŠ è½½elè¡¨è¾¾å¼çš„æ„å»ºç±»**

```
public static ThenELWrapper then(ELWrapper... elWrappers){
        checkNotBooleanArgs(elWrappers);
        return new ThenELWrapper(elWrappers);
    }

    public static ThenELWrapper then(Object ... objects){
        ELWrapper[] elWrappers = convertToNonLogicOpt(objects);
        return new ThenELWrapper(elWrappers);
    }
```



æç¤º

ä¸ºäº†é¿å…å¯èƒ½çš„å†²çªï¼Œnode("")å°†ç»„ä»¶åè¿›è¡Œäº†åŒ…è£…ï¼Œä»¥ç¡®ä¿Nodeçš„åç§°ä¸LiteFlowç»„ä»¶åè§„èŒƒä¸å‘ç”Ÿå†²çªã€‚æ›´è¯¦ç»†çš„å†…å®¹è¯·æŸ¥çœ‹[ç»„ä»¶ååŒ…è£…](https://liteflow.cc/pages/2df3d9/)ã€‚

é™¤äº†æ„å»ºè¡¨è¾¾å¼ä¹‹å¤–ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨è¡¨è¾¾å¼ä¸­è°ƒç”¨è¡¨è¾¾å¼çš„å…³é”®å­—ï¼Œæ¯”å¦‚ä¸ºé€‰æ‹©ç»„ä»¶çš„å­ç»„ä»¶è®¾ç½®idã€tagï¼Œè®¾ç½®å¹¶è¡Œç»„ä»¶çš„anyå…³é”®å­—ç­‰ç­‰ã€‚å¦‚ä¸‹ä¾‹æ‰€ç¤ºï¼š

```xml
<!-- ç›®æ ‡ELè¡¨è¾¾å¼ -->
<chain name="chain1">
whenData = '{"name":"zhangsan","age":18}';

WHEN(
	node("a"),
	WHEN(
		node("b"),
		node("c")
	).id("this is a id").data(whenData),
	node("d")
).any(true).tag("this is a tag")
</chain>
```

å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹æ³•ç»„è£…å‡ºè¯¥ELè¡¨è¾¾å¼ï¼Œè°ƒç”¨å¯¹åº”çš„å…³é”®å­—ï¼Œå¹¶è¾“å‡ºå¯¹åº”çš„è¡¨è¾¾å¼ã€‚

```java
// ELè¡¨è¾¾å¼ç»„è£…
WhenELWrapper el = ELBus.when("a",
		ELBus.when("b").when("c")
				.data("whenData", "{\"name\":\"zhangsan\",\"age\":18}")
				.id("this is a id"),
		"d").tag("this is a tag").any(true);
```

è¯¥ELè¡¨è¾¾å¼è¾“å‡ºå¦‚ä¸‹ï¼š

```java
whenData = '{"name":"zhangsan","age":18}';
WHEN(node("a"),WHEN(node("b"),node("c")).id("this is a id").data(whenData),node("d")).any(true).tag("this is a tag")
```

## [#](https://liteflow.cc/pages/a3cb4b/#æ ¼å¼åŒ–è¾“å‡ºelè¡¨è¾¾å¼)æ ¼å¼åŒ–è¾“å‡ºELè¡¨è¾¾å¼

å®¹æ˜“èƒ½å‘ç°`toEL()`æ–¹æ³•è¾“å‡ºçš„ELè¡¨è¾¾å¼æ˜¯ä¸€è¡Œå­—ç¬¦ä¸²ï¼Œä¸æ–¹ä¾¿æŸ¥çœ‹ä»¥åŠæ ¡éªŒELè¡¨è¾¾å¼æ˜¯å¦æ­£ç¡®ã€‚å¯ä»¥ä½¿ç”¨ `toEL(true)` æ–¹æ³•ä»¥æ ‘å½¢ç»“æ„è¾“å‡ºELè¡¨è¾¾å¼ã€‚å¯¹äºä¸Šä¸€ä¸ªä¾‹å­ä¸­çš„ELè¡¨è¾¾å¼ï¼Œè°ƒç”¨`el.toEL(true)`æ–¹æ³•ï¼Œå¾—åˆ°æ ‘å‹ç»“æ„è¡¨è¾¾å¼è¾“å‡ºå¦‚ä¸‹ï¼š

```java
whenData = '{"name":"zhangsan","age":18}';
WHEN(
	node("a"),
	WHEN(
		node("b"),
		node("c")
	).id("this is a id").data(whenData),
	node("d")
).any(true).tag("this is a tag")
```

## [#](https://liteflow.cc/pages/a3cb4b/#ç›®å‰æ”¯æŒçš„è¡¨è¾¾å¼å’Œå…³é”®å­—)ç›®å‰æ”¯æŒçš„è¡¨è¾¾å¼å’Œå…³é”®å­—

ç›®å‰æ”¯æŒåˆ°2.11.1ç‰ˆæœ¬çš„æ‰€æœ‰ELè¡¨è¾¾å¼ï¼ŒåŒ…æ‹¬å…¶ä¸­çš„å…³é”®å­—å’Œé«˜çº§ç‰¹æ€§ã€‚å½“å‰æ”¯æŒçš„è¯¦ç»†å†…å®¹å¦‚ä¸‹è¡¨ï¼š

| ELè¡¨è¾¾å¼       | åˆ›å»ºæ–¹æ³•                                      | æ”¯æŒè°ƒç”¨æ–¹æ³•                                                 | æ”¯æŒå…³é”®å­—                                                   |
| -------------- | --------------------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| ä¸²è¡Œç¼–æ’       | ELBus.then                                    | then(Object ... objects)                                     | pre finally tag id data maxWaitSeconds                       |
| å¹¶è¡Œç¼–æ’       | ELBus.when                                    | when(Object ... objects)                                     | any ignoreError customThreadExecutor must tag id data maxWaitSeconds |
| é€‰æ‹©ç¼–æ’       | ELBus.switch                                  | to(Object... objects) defaultOpt(Object object)              | tag id data maxWaitSeconds                                   |
| æ¡ä»¶ç¼–æ’       | ELBus.ifOpt                                   | elseOpt(Object falseObject) elIfOpt(Object ifObject, Object trueObject) | tag id data maxWaitSeconds                                   |
| å¾ªç¯ç¼–æ’       | ELBus.forOpt ELBus.whileOpt ELBus.iteratorOpt | doOpt(Object object) breakOpt(Object object) (ITERATORè¿­ä»£å™¨å¾ªç¯è¡¨è¾¾å¼ä¸æ”¯æŒ) | parallel tag id data maxWaitSeconds                          |
| æ•è·å¼‚å¸¸è¡¨è¾¾å¼ | ELBus.catchException                          | doOpt(Object object)                                         | tag id data maxWaitSeconds                                   |
| ä¸è¡¨è¾¾å¼       | ELBus.and                                     | and(Object ... object)                                       | tag id data maxWaitSeconds                                   |
| æˆ–è¡¨è¾¾å¼       | ELBus.or                                      | or(Object ... object)                                        | tag id data maxWaitSeconds                                   |
| éè¡¨è¾¾å¼       | ELBus.not                                     |                                                              | tag id data maxWaitSeconds                                   |
| å•èŠ‚ç‚¹è¡¨è¾¾å¼   | ELBus.node                                    |                                                              | tag data maxWaitSeconds                                      |
| å‰ç½®ç»„ä»¶       | é€šè¿‡thenç»„ä»¶çš„preå…³é”®å­—åˆ›å»º                   |                                                              | tag id data maxWaitSeconds                                   |
| åç½®ç»„ä»¶       | é€šè¿‡thenç»„ä»¶çš„finallyå…³é”®å­—åˆ›å»º               |                                                              | tag id data                                                  |

## [#](https://liteflow.cc/pages/a3cb4b/#elè¡¨è¾¾å¼å‚æ•°æ ¡éªŒ)ELè¡¨è¾¾å¼å‚æ•°æ ¡éªŒ

ç»„è£…è¡¨è¾¾å¼æ—¶ä¼šå¯¹è¡¨è¾¾å¼çš„å‚æ•°ç±»å‹è¿›è¡Œæ ¡éªŒã€‚åŒ…æ‹¬æ˜¯å¦ä¸ºå•èŠ‚ç‚¹ç»„ä»¶ã€æ˜¯å¦å…è®¸ä¸ºä¸æˆ–éè¡¨è¾¾å¼ç­‰ã€‚æ¯”å¦‚ï¼ŒWHILEè¡¨è¾¾å¼`WHILE(w).DO(THEN(a, b));` ä¸­ï¼Œwéœ€è¦æ˜¯è¿”å›å¸ƒå°”å€¼çš„èŠ‚ç‚¹æˆ–ä¸æˆ–éè¡¨è¾¾å¼ã€‚

æ›´å¤šæµ‹è¯•æ ·ä¾‹è¯·åœ¨ `liteflow-testcase-el/liteflow-testcase-el-builder` æ¨¡å—ä¸­æŸ¥çœ‹ã€‚